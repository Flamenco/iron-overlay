<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="iron-overlay-renderer-shared-styles.html">

<!--
`iron-overlay-renderer` renders the overlay content in the center of the screen,
and handles the switch from opened state to closed state & viceversa.

### Styling

`iron-overlay` sets its renderer attribute `data-overlay` to its id, so that
styling can be done like this:

    <style is="custom-style">
      iron-overlay-renderer {
        --iron-overlay-background-color: yellow;
      }
      [data-overlay="overlay1"] {
        --iron-overlay-background-color: orange;
      }
    </style>

    <iron-overlay-container></iron-overlay-container>

    <iron-overlay>
      <template>Overlay Content</template>
    </iron-overlay>
    <iron-overlay id="overlay1">
      <template>Overlay 1 Content</template>
    </iron-overlay>

@demo demo/index.html
-->

<dom-module id="iron-overlay-renderer">
  <template strip-whitespace>
    <style include="iron-overlay-renderer-shared-styles"></style>
    <div id="overlay" tabindex="0">
      <slot></slot>
    </div>
  </template>

  <script>
    (function() {
      'use strict';

      const _openedChanged = Symbol();
      const _startRenderOpenedChanged = Symbol();
      const _raf = Symbol();
      const _forceLayout = Symbol();

      class IronOverlayRenderer extends Polymer.Element {

        static get is() {
          return 'iron-overlay-renderer';
        }

        static get config() {
          return {
            properties: {
              /**
               * True if the overlay is currently displayed.
               */
              opened: {
                type: Boolean,
                observer: _openedChanged
              },

              /**
               * Is true during the transition from close to open and open to close.
               */
              transitioning: {
                type: Boolean,
                notify: true,
                readOnly: true
              }
            }
          };
        }

        constructor() {
          super();
          // Ensure it's not visible by default.
          this.style.display = 'none';
          // For a performant transition from open to close and close to open.
          this[_raf] = null;
          this[_startRenderOpenedChanged] = this[_startRenderOpenedChanged].bind(this);
        }

        disconnectedCallback() {
          super.disconnectedCallback();
          if (this[_raf]) {
            window.cancelAnimationFrame(this[_raf]);
            this[_raf] = null;
            this._finishRenderOpenedChanged();
          }
        }

        /**
         * Tasks to be performed to actually open/close. Override this to play
         * animations, and call `_finishRenderOpenedChanged()` when those are done.
         * @protected
         */
        _renderOpenedChanged() {
          this._finishRenderOpenedChanged();
        }

        /**
         * @protected
         */
        _finishRenderOpenedChanged() {
          // Ensure it is not displayed.
          if (!this.opened) {
            this.style.display = 'none';
          }
          this._setTransitioning(false);
        }

        /**
         * @param {boolean} opened
         */
        [_openedChanged](opened) {
          this[_raf] && window.cancelAnimationFrame(this[_raf]);
          this[_raf] = window.requestAnimationFrame(this[_startRenderOpenedChanged]);
        }

        /**
         * Starts the update from open to closed & viceversa.
         */
        [_startRenderOpenedChanged]() {
          this[_raf] = null;
          this._setTransitioning(true);
          this.style.pointerEvents = this.opened ? '' : 'none';
          // Ensure it is displayed.
          if (this.opened && this.style.display) {
            this.style.display = '';
            this[_forceLayout]();
          }
          this._renderOpenedChanged();
        }

        /**
         * Forces layout.
         */
        [_forceLayout]() {
          return this.offsetWidth;
        }

      }

      Polymer.IronOverlayRenderer = IronOverlayRenderer;
      customElements.define(IronOverlayRenderer.is, IronOverlayRenderer);

    })();
  </script>
</dom-module>
